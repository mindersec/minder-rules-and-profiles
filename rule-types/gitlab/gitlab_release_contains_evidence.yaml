---
version: v1
type: rule-type
name: gitlab_release_contains_evidence
display_name: Gitlab release contains evidence
short_failure_message: Release does not contain evidence
severity:
  value: medium
context:
  provider: gitlab
release_phase: alpha
description: |
  Foo bar
guidance: |
  Bar baz
def:
  in_entity: release
  rule_schema: {}
  ingest:
    type: rest
    rest:
      endpoint: '/projects/{{ mapGet .Entity.Properties "gitlab/project_id" }}/releases/{{ mapGet .Entity.Properties "gitlab/tag" }}'
      parse: json
  eval:
    type: rego
    rego:
      type: deny-by-default
      def: |
        package minder

        default allow := false
        default message := "Release does not contain evidences"

        allow {
          # Check that there is at least one evidence included in the release
          count(input.ingested.evidences) > 0
        }

